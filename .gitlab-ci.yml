stages:
    - preevaluation
    - synthesis
    - benchmark

documentation:
    stage: preevaluation
    only:
        - staging
        - main
    tags:
        - docker-shared
    image: "alpine"
    before_script:
        - apk add --no-cache doxygen graphviz font-noto
    script:
        - doxygen
    artifacts:
        paths:
            - "doxygen/html"

unit_test:
    stage: preevaluation
    only:
        - staging
        - main
    tags:
        - noctua2
    variables:
        SCHEDULER_PARAMETERS: "-A hpc-lco-kenter -p normal -t 0:05:00 -c 14 --mem 4G"
    before_script:
        - "ml fpga devel intel/oneapi bittware/520n Boost CMake"
    script:
        - "mkdir -p build"
        - "cd build"
        - "cmake .."
        - "make unit_test -j14"
        - "./tests/unit_test"

convection synthesis:
    stage: synthesis
    only:
        - staging
        - main
        - convection
    tags:
        - noctua2
    variables:
        SCHEDULER_PARAMETERS: "-A hpc-lco-kenter -p normal -q fpgasynthesis -t 1-00:00:00 -c 8 --mem 120G"
    before_script:
        - "ml fpga devel intel/oneapi bittware/520n Boost CMake"
    script:
        - "mkdir -p build"
        - "cd build"
        - "cmake -DCMAKE_BUILD_TYPE=Release .."
        - "make convection"
    artifacts:
        when: always
        paths:
            - "build/examples/convection/convection"
            - "build/examples/convection/convection.prj/reports"

convection benchmark:
    stage: benchmark
    only:
        - staging
        - main
        - convection
    needs: 
        - "convection synthesis"
    tags:
        - noctua2
    variables:
        SCHEDULER_PARAMETERS: "-A hpc-lco-kenter -p fpga --constraint=bittware_520n_20.4.0_hpc -t 00:30:00"
    before_script:
    script:
        - "cd examples/convection"
        - "module reset"
        - "module load fpga devel intel/oneapi bittware/520n Boost CMake"
        - "mkdir out"
        - "time aocl profile -e ../../build/examples/convection/convection ../../build/examples/convection/convection experiments/default.json out > convection.out &"

        - "module reset"
        - "module load lang JuliaHPC"
        - "time julia --project -t128 -O3 ./ThermalConvection2D.jl > reference.out"
        - "wait"

        - "julia --project -t128 ./render_animation.jl out T_out"
    artifacts:
        paths:
            - "examples/convection/profile.json"
            - "examples/convection/*.out"
            - "examples/convection/out"
            - "examples/convection/T_out"
            - "examples/convection/animation.mp4"
