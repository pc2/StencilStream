stages:
    - preevaluation
    - synthesis
    - benchmark
    - analysis

default:
    before_script:
        - "module reset"
        - "module load lang fpga devel intel/oneapi bittware/520n Boost CMake Julia"
        - "icpx --version"
        - "julia --version"

documentation:
    stage: preevaluation
    only:
        - staging
        - main
    tags:
        - docker-shared
    image: "alpine"
    before_script:
        - apk add --no-cache doxygen graphviz font-noto
    script:
        - doxygen
    artifacts:
        paths:
            - "doxygen/html"

unit_test:
    stage: preevaluation
    only:
        - staging
        - main
    tags:
        - noctua2
    variables:
        SCHEDULER_PARAMETERS: "-A hpc-lco-kenter -p normal -t 0:05:00 -c 14 --mem 4G"
    script:
        - "mkdir -p build"
        - "cd build"
        - "cmake .."
        - "make unit_test -j14"
        - "./tests/unit_test"

convection synthesis:
    stage: synthesis
    only:
        - staging
        - main
        - convection
    tags:
        - noctua2
    variables:
        SCHEDULER_PARAMETERS: "-A hpc-lco-kenter -p normal -t 00:10:00 -c 1"
    script:
        - "mkdir -p build"
        - "cd build"
        - "cmake -DCMAKE_BUILD_TYPE=Release .."
        - "make convection_cpu"
    artifacts:
        when: always
        paths:
            - "build/examples/convection/convection_cpu"

convection benchmark:
    stage: benchmark
    only:
        - staging
        - main
        - convection
    needs: 
        - "convection synthesis"
    tags:
        - noctua2
    variables:
        SCHEDULER_PARAMETERS: "-A hpc-lco-kenter -p normal -c 16 -t 00:30:00"
        DPCPP_CPU_NUM_CUS: 16
    script:
        - "cd examples/convection"
        - "julia --project -e 'using Pkg; Pkg.instantiate(); Pkg.precompile()'"
        - "mkdir out"
        - "../../build/examples/convection/convection_cpu experiments/default.json out | julia --project analyze_log.jl fpga > metrics.txt"
    artifacts:
        reports:
            metrics: examples/convection/metrics.txt
        paths:
            - "examples/convection/out"
            - "examples/convection/profile.json"
            - "examples/convection/performance_fpga.csv"

convection reference benchmark:
    stage: benchmark
    only:
        - staging
        - main
        - convection
    tags:
        - noctua2
    variables:
        SCHEDULER_PARAMETERS: "-A hpc-lco-kenter -p normal --exclusive -t 00:10:00"
    script:
        - "cd examples/convection"
        - "julia --project -O3 -e 'using Pkg; Pkg.instantiate(); Pkg.precompile()'"
        - "julia --project -t128 -O3 ./ThermalConvection2D.jl | julia --project -O3 analyze_log.jl cpu > metrics.txt"
    artifacts:
        reports:
            metrics: examples/convection/metrics.txt
        paths:
            - "examples/convection/reference_out"
            - "examples/convection/performance_cpu.csv"

convection benchmark analysis:
    stage: analysis
    only:
        - staging
        - main
        - convection
    needs: 
        - "convection benchmark"
        - "convection reference benchmark"
    tags:
        - noctua2
    variables:
        SCHEDULER_PARAMETERS: "-A hpc-lco-kenter -p normal -c 8 -t 00:05:00"
    script:
        - "cd examples/convection"
        - "julia --project -e 'using Pkg; Pkg.instantiate(); Pkg.precompile()'"
        - "julia --project -t8 ./render_animation.jl out reference_out > metrics.txt"
    artifacts:
        reports:
            metrics: examples/convection/metrics.txt
        paths:
            - "examples/convection/animation.mp4"
